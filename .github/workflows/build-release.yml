name: Build PortaPack Release

on:
  push:
    branches: [ main ]
    paths:
      - 'nmea_converter_portapack_release/**'
      - '.github/workflows/build-release.yml'
  workflow_dispatch:

jobs:
  build-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      
    - name: Install RP2040/RP2350 Core
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json
        arduino-cli core update-index
        arduino-cli core install rp2040:rp2040
    
    - name: Build Release Firmware
      run: |
        mkdir -p ./release
        arduino-cli compile --fqbn rp2040:rp2040:rpipico2 --output-dir ./release --export-binaries ./nmea_converter_portapack_release
    
    - name: Create Release Documentation
      run: |
        cat > ./release/README.txt << 'EOF'
        NMEA UART to I2C Converter for PortaPack H4M
        =============================================
        Version: 1.3 RELEASE - Dual-Core Architecture
        Board: Waveshare RP2350-Zero
        I2C Address: 0x10 (PortaPack standard)
        
        WHAT'S NEW IN v1.3:
        â­ DUAL-CORE ARCHITECTURE:
        - Core 0: Dedicated UART processing
        - Core 1: Dedicated I2C communication
        - ELIMINATED all conflicts between UART and I2C
        - Thread-safe operations with critical sections
        - Improved stability and performance
        
        Previous versions:
        - v1.2: 255-byte I2C packets (maximum)
        - v1.1: 96-byte I2C packets
        - v1.0: 32-byte I2C packets
        
        FEATURES:
        - UART to I2C bridge for NMEA GPS data
        - 4KB circular buffer with thread safety
        - Zero conflicts between UART receive and I2C requests
        - Compatible with PortaPack H4M GPS application
        - Internal I2C pull-up resistors enabled
        - NO filtering - ALL NMEA messages are passed through
        
        CONNECTIONS:
        GPS Module          RP2350-Zero         PortaPack H4M
        ----------          -----------         -------------
        VCC (3.3V) -------> 3V3                
        GND --------------> GND --------------> GND
        TX ---------------> GPIO1 (Pin 1)      
                           GPIO4 (Pin 4) ----> SDA
                           GPIO5 (Pin 5) ----> SCL
        
        PIN MAPPING (Right side of RP2350-Zero, top to bottom):
        Pin 0 = GPIO0
        Pin 1 = GPIO1 <- GPS RX HERE
        Pin 2 = GPIO2
        Pin 3 = GPIO3
        Pin 4 = GPIO4 <- I2C SDA HERE
        Pin 5 = GPIO5 <- I2C SCL HERE
        
        INSTALLATION:
        1. Connect RP2350-Zero to PC via USB-C
        2. Hold BOOT button and press RESET
        3. Copy nmea_converter_portapack_release.uf2 to RPI-RP2 drive
        4. Board will reboot automatically
        
        USAGE:
        1. Connect GPS module TX to GPIO1 (Pin 1)
        2. Connect I2C from RP2350-Zero to PortaPack
        3. Power on PortaPack and start GPS app
        4. GPS data should appear automatically
        
        I2C PROTOCOL:
        - 0x01: GET_STATUS (returns 1 byte)
        - 0x02: GET_COUNT (returns 2 bytes, little-endian)
        - 0x03: READ_DATA (returns up to 255 bytes)
        - 0x04: CLEAR_BUFFER (returns 0x01)
        - 0x05: GET_VERSION (returns 0x13 for v1.3)
        - 0x06: GET_INFO (extended info with core statistics)
        
        STATUS OUTPUT (via USB Serial):
        Connect to serial monitor (115200 baud) to see:
        - Real-time statistics every 10 seconds
        - UART characters processed
        - I2C requests handled
        - Buffer status and data rate
        - Error counts
        
        DUAL-CORE BENEFITS:
        1. No buffer conflicts - each core has dedicated tasks
        2. Higher throughput - parallel processing
        3. Better stability - isolated operations
        4. Zero blocking between UART and I2C
        
        NMEA MESSAGES:
        ALL NMEA messages from GPS are transmitted without filtering:
        - GPS: $GPGGA, $GPRMC, $GPGSA, $GPGSV, $GPVTG, $GPGLL
        - GLONASS: $GLGGA, $GLRMC, $GLGSV
        - Multi-GNSS: $GNGGA, $GNRMC, $GNGSA
        - Proprietary: $PMTK, $PUBX, etc.
        
        Build Date: $(date)
        EOF
    
    - name: Create Version File
      run: |
        echo "1.3.0" > ./release/VERSION
        echo "Release for PortaPack H4M" >> ./release/VERSION
        echo "I2C Address: 0x10" >> ./release/VERSION
        echo "I2C Packet: 255 bytes (MAX)" >> ./release/VERSION
        echo "Architecture: Dual-Core (Core0: UART, Core1: I2C)" >> ./release/VERSION
        echo "Build: $(date +%Y%m%d-%H%M%S)" >> ./release/VERSION
    
    - name: Upload Release Package
      uses: actions/upload-artifact@v4
      with:
        name: NMEA-Converter-PortaPack-v1.3-RELEASE
        path: |
          release/*.uf2
          release/README.txt
          release/VERSION
        retention-days: 90
